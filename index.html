<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Art Portfolio + Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    body { background: linear-gradient(180deg,#0f172a 0%, #0a1a45 60%); color: #e6eef8; font-family: 'Inter', sans-serif; }
    .glass { background: rgba(255,255,255,0.06); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
    .art-card hover:scale-[1.02] transition-all duration-300 img { height: 240px; object-fit: cover; transition: transform 0.3s ease; }
    pre.sql { background: rgba(0,0,0,0.35); padding: 10px; border-radius:6px; overflow:auto; }
    .hint { background: rgba(255,255,255,0.02); padding:10px; border-radius:8px; }
    .log { font-family: monospace; font-size: 12px; white-space: pre-wrap; }
    .badge { background: rgba(255,255,255,0.04); padding: 2px 8px; border-radius: 999px; }
  </style>
</head>
<body class="min-h-screen p-6">
  <div class="max-w-7xl mx-auto">
    <header class="flex items-center justify-between mb-8">
      <div></div>
      <div class="flex gap-3">
        <button id="btn-open-gallery" class="px-4 py-2 glass rounded">Gallery</button>
        <button id="btn-open-admin" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded">Admin</button>
      </div>
    </header>

    <main id="page-gallery" class="space-y-6">
      <section class="grid lg:grid-cols-3 md:grid-cols-2 gap-6" id="gallery-grid"></section>
      <div id="gallery-empty" class="text-center opacity-80">‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô...</div>
    </main>

    <section id="page-admin" class="hidden glass rounded-lg p-6 mt-6">
      <div class="flex justify-between items-start gap-6">
        <div class="w-80">
          <h2 class="text-xl font-semibold mb-3">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</h2>
          <form id="login-form" class="space-y-3">
            <input id="email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" class="w-full p-3 rounded bg-transparent border border-white/10" />
            <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 rounded bg-transparent border border-white/10" />
            <div class="flex gap-2">
              <button type="submit" class="px-4 py-2 bg-emerald-600 rounded">Sign in</button>
              <button id="btn-signout" type="button" class="px-4 py-2 bg-red-600 rounded hidden">Sign out</button>
            </div>
            <div id="auth-msg" class="text-sm mt-2 opacity-80"></div>
          </form>
        </div>

        <div class="flex-1 hidden" id="admin-panel">
          <h2 class="text-xl font-semibold mb-3">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏á‡∏≤‡∏ô</h2>
          <div id="admin-controls" class="space-y-4">
            <form id="art-form" class="grid grid-cols-2 gap-3 items-end">
              <input id="art-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô" class="p-2 rounded bg-transparent border border-white/10 col-span-2" />
              <textarea id="art-desc" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" class="p-2 rounded bg-transparent border border-white/10 col-span-2"></textarea>

              <!-- Source selector: file (local) or link (URL) -->
              <div class="col-span-2 flex items-center gap-4">
                <label class="flex items-center gap-2"><input type="radio" name="art-source" value="file" id="art-source-file" checked /> ‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á</label>
                <label class="flex items-center gap-2"><input type="radio" name="art-source" value="link" id="art-source-link" /> ‡πÉ‡∏ä‡πâ‡∏•‡∏¥‡∏á‡∏Å‡πå (URL)</label>
              </div>

              <!-- File input -->
              <input id="art-file" type="file" accept="image/*" class="col-span-2" />

              <!-- URL input (hidden by default) -->
              <input id="art-url" type="url" placeholder="‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û (https://...)" class="p-2 rounded bg-transparent border border-white/10 col-span-2 hidden" />

              <label class="flex items-center gap-2 col-span-2"><input id="art-publish" type="checkbox" /> ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà</label>
              <button id="btn-upload" class="px-4 py-2 bg-blue-600 rounded col-span-2">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î / ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô</button>
            </form>

            <div>
              <h3 class="font-semibold">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏á‡∏≤‡∏ô (‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•)</h3>
              <div id="admin-list" class="mt-3 grid md:grid-cols-2 gap-3"></div>
            </div>

            <div id="rls-help" class="mt-4 text-sm opacity-80 hidden">
              <div class="hint">
                <p class="font-semibold">‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î RLS (row-level security) ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤ bucket</p>
                <p>‡∏£‡∏±‡∏ô SQL ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Supabase ‚Üí SQL Editor ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á Storage policies ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                <pre class="sql">-- Database (artworks table)
alter table if exists public.artworks add column if not exists created_by uuid references auth.users(id);
alter table public.artworks enable row level security;

-- Allow authenticated users to insert rows where created_by = auth.uid()
create policy "users can insert own artworks" on public.artworks for insert to authenticated with check (auth.uid() = created_by);
create policy "users can select own artworks" on public.artworks for select to authenticated using (auth.uid() = created_by);

-- Storage policies (in Storage ‚Üí Policies for bucket 'artworks')
-- In the Storage UI you MUST NOT paste a full CREATE POLICY statement.
-- Instead, choose Allowed operations: INSERT + upload (for upload), Target role: authenticated,
-- and in the Policy definition box enter only the boolean expression shown below.

-- For upload (INSERT + upload) enter this in Policy definition box:
bucket_id = 'artworks'

-- For read (SELECT) enter this in Policy definition box:
bucket_id = 'artworks'
                </pre>
                <p class="mt-2">‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤<strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏Ñ‡πÄ‡∏Å‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å</strong> <span class="badge">artworks</span> ‡πÅ‡∏•‡∏∞ Policy definition ‡πÉ‡∏ô UI ‡πÉ‡∏™‡πà‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÄ‡∏ä‡πà‡∏ô <code>bucket_id = 'artworks'</code></p>
              </div>
            </div>

            <div id="last-log" class="mt-3 text-sm opacity-80 log"></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="mt-10 text-sm opacity-70">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô API Keys ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á RLS ‡πÉ‡∏ô Supabase ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</footer>
  </div>

  <script>
    // ============== CONFIG ==============
    const SUPABASE_URL = 'https://yrivvckaeqhfcjuputem.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlyaXZ2Y2thZXFoZmNqdXB1dGVtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0MjYzNjksImV4cCI6MjA4MDAwMjM2OX0.Hw7rtrJyXS6sClytRKSYutvW7Co5l_jmbOUOduo30u0';
    // MUST match your Supabase Storage bucket name exactly (case-sensitive)
    const BUCKET_NAME = 'artworks';
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10 MB
    const ALLOWED_MIMES = ['image/jpeg','image/png','image/webp'];
    // ======================================

    // instantiate properly
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Improved error formatter: prints nested objects, status, message
    function formatErr(err){
      if(!err) return '';
      if(typeof err === 'string') return err;
      // If it's Supabase error object
      if(err.message && err.status) return `${err.message} (status: ${err.status})`;
      if(err.error && err.error.message) return `${err.error.message}`;
      if(err.message) return err.message;
      try{ return JSON.stringify(err, Object.getOwnPropertyNames(err), 2); }catch(e){ return String(err); }
    }

    // UI refs
    const galleryGrid = document.getElementById('gallery-grid');
    const galleryEmpty = document.getElementById('gallery-empty');
    const pageAdmin = document.getElementById('page-admin');
    const pageGallery = document.getElementById('page-gallery');
    const btnOpenAdmin = document.getElementById('btn-open-admin');
    const btnOpenGallery = document.getElementById('btn-open-gallery');

    const loginForm = document.getElementById('login-form');
    const authMsg = document.getElementById('auth-msg');
    const btnSignOut = document.getElementById('btn-signout');
    const artForm = document.getElementById('art-form');
    const adminList = document.getElementById('admin-list');
    const adminControls = document.getElementById('admin-controls');
    const rlsHelp = document.getElementById('rls-help');
    const lastLog = document.getElementById('last-log');

    function logLast(txt){ lastLog.textContent = txt; console.log('APP LOG:', txt); }

    btnOpenAdmin.addEventListener('click', async () => {
      pageAdmin.classList.remove('hidden');
      pageGallery.classList.add('hidden');
      try{
        const { data } = await supabaseClient.auth.getSession();
        if(!data || !data.session){
          adminControls.classList.add('hidden');
          document.getElementById('admin-panel').classList.add('hidden');
          authMsg.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î';
        } else {
          adminControls.classList.remove('hidden');
          document.getElementById('admin-panel').classList.remove('hidden');
          authMsg.textContent = '';
          await loadAdminList();
        }
        await checkSession();
      }catch(err){
        console.error(err);
        authMsg.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + formatErr(err);
      }
    });

    btnOpenGallery.addEventListener('click', () => { pageAdmin.classList.add('hidden'); pageGallery.classList.remove('hidden'); loadGallery(); });

    // initial load
    loadGallery();
    checkSession();

    async function loadGallery(){
      galleryGrid.innerHTML = '';
      galleryEmpty.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ú‡∏•‡∏á‡∏≤‡∏ô...';
      try{
        const { data, error } = await supabaseClient.from('artworks').select('*').eq('published', true).order('created_at', {ascending: false});
        if(error){
          const msg = formatErr(error);
          galleryEmpty.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î: ' + msg;
          console.error(error);
          return;
        }
        if(!data || data.length === 0){ galleryEmpty.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà'; return; }
        galleryEmpty.textContent = '';
        data.forEach(art => {
          const card = document.createElement('article');
          card.className = 'art-card rounded-lg overflow-hidden glass p-0';
          card.innerHTML = `
            ${art.image_url && !art.image_url.match(/\.(jpg|jpeg|png|webp)$/i) ? `<iframe src="${art.image_url}" class="w-full h-60 bg-black/20"></iframe>` : `<img src="${art.image_url || 'https://via.placeholder.com/600x400?text=No+Image'}" alt="${escapeHtml(art.title)}" class="w-full"/>`}
            <div class="p-4">
              <h3 class="font-semibold text-lg">${escapeHtml(art.title)}</h3>
              <p class=\"text-sm mt-2 opacity-80\">${escapeHtml(art.description || '')}</p>
              ${art.image_url?.startsWith('http') ? `<a href=\"${art.image_url}\" target=\"_blank\" class=\"text-blue-400 underline text-sm block mt-2\">üîó ‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</a>` : ''}
            </div>
          `;
          galleryGrid.appendChild(card);
        });
      }catch(err){
        console.error(err);
        galleryEmpty.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î: ' + formatErr(err);
      }
    }

    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if(!email || !password){ authMsg.textContent = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô'; return; }
      authMsg.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...';
      try{
        const resp = await supabaseClient.auth.signInWithPassword({ email, password });
        if(resp.error){ const msg = formatErr(resp.error); authMsg.textContent = '‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + msg; console.error(resp.error); return; }
        // resp.data.session available when success
        authMsg.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
        adminControls.classList.remove('hidden');
        btnSignOut.classList.remove('hidden');
        document.getElementById('admin-panel').classList.remove('hidden');
        await loadAdminList();
      }catch(err){ console.error(err); authMsg.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ' + formatErr(err); }
    });

    btnSignOut.addEventListener('click', async ()=>{
      try{ await supabaseClient.auth.signOut(); authMsg.textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß'; btnSignOut.classList.add('hidden'); adminControls.classList.add('hidden'); adminList.innerHTML=''; }catch(err){ console.error(err); authMsg.textContent = '‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + formatErr(err); }
    });

    async function checkSession(){
      try{ const { data } = await supabaseClient.auth.getSession(); if(data && data.session){ btnSignOut.classList.remove('hidden'); } else { btnSignOut.classList.add('hidden'); } }catch(err){ console.error(err); }
    }

    // --- UI: toggle between File input and URL input when source radio changes ---
    const artSourceFile = document.getElementById('art-source-file');
    const artSourceLink = document.getElementById('art-source-link');
    const artUrlInput = document.getElementById('art-url');
    const artFileInput = document.getElementById('art-file');

    function toggleSourceInputs(){
      const source = document.querySelector('input[name="art-source"]:checked')?.value || 'file';
      if(source === 'link'){
        artUrlInput.classList.remove('hidden');
        artFileInput.classList.add('hidden');
        artUrlInput.focus();
      } else {
        artUrlInput.classList.add('hidden');
        artFileInput.classList.remove('hidden');
      }
    }

    // initialize and wire events
    toggleSourceInputs();
    document.querySelectorAll('input[name="art-source"]').forEach(r => r.addEventListener('change', toggleSourceInputs));

    // Upload handler - simplified to target the confirmed bucket name 'artworks' (supports file OR external URL)
    document.getElementById('btn-upload').addEventListener('click', async (e)=>{
      e.preventDefault();
      rlsHelp.classList.add('hidden');

      const title = document.getElementById('art-title').value.trim();
      const desc = document.getElementById('art-desc').value.trim();
      const fileInput = document.getElementById('art-file');
      const urlInput = document.getElementById('art-url');
      const publish = document.getElementById('art-publish').checked;
      const source = document.querySelector('input[name="art-source"]:checked')?.value || 'file';

      if(!title){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏á‡∏≤‡∏ô'); return; }
      if(source === 'file' && (!fileInput.files || fileInput.files.length===0)){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á'); return; }
      if(source === 'link' && !urlInput.value.trim()){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏†‡∏≤‡∏û'); return; }

      // ensure authenticated (for inserting record)
      const sessionResp = await supabaseClient.auth.getSession();
      const userId = sessionResp?.data?.session?.user?.id || null;
      if(!userId){ alert('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'); return; }

      try{
        let imageUrl = '';

        if(source === 'file'){
          const file = fileInput.files[0];
          const fileExt = file.name.split('.').pop();
          const filePath = `${userId}/${Date.now()}-${Math.random().toString(36).slice(2,8)}.${fileExt}`;

          // validate file
          if(file.size > MAX_FILE_SIZE){ alert('‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‚Äî ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà 10 MB'); return; }
          if(!ALLOWED_MIMES.includes(file.type)){
            alert('‡∏ä‡∏ô‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö ‚Äî ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ jpg/png/webp');
            return;
          }

          logLast(`Uploading to bucket: ${BUCKET_NAME} path: ${filePath}`);
          const { data: upData, error: upErr } = await supabaseClient.storage.from(BUCKET_NAME).upload(filePath, file, { cacheControl: '3600', upsert: false });
          if(upErr){
            const msg = formatErr(upErr);
            console.error('Storage upload error object:', upErr);
            if(upErr.status === 404 || msg.toLowerCase().includes('bucket')){
              alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏ö‡∏±‡∏Ñ‡πÄ‡∏Å‡πá‡∏ï‡πÑ‡∏°‡πà‡∏û‡∏ö (‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏Ñ‡πÄ‡∏Å‡πá‡∏ï‡πÉ‡∏ô Supabase Storage ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô "artworks")');
              rlsHelp.classList.remove('hidden');
              logLast('Upload failed: bucket not found.');
              return;
            }
            if(upErr.status === 403 || msg.toLowerCase().includes('permission')){
              alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏°‡πà‡∏û‡∏≠ (‡∏ï‡∏£‡∏ß‡∏à Storage policies ‡πÅ‡∏•‡∏∞ RLS ‡∏ß‡πà‡∏≤‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)');
              rlsHelp.classList.remove('hidden');
              logLast('Upload failed: permission denied. ' + msg);
              return;
            }
            alert('‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + msg);
            rlsHelp.classList.remove('hidden');
            logLast('Upload failed: ' + msg);
            return;
          }

          const { data: publicUrlData, error: urlErr } = await supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(filePath);
          if(urlErr){ const msg = formatErr(urlErr); console.error('getPublicUrl error:', urlErr); alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á public URL: ' + msg); logLast('getPublicUrl error: ' + msg); return; }
          imageUrl = publicUrlData?.publicUrl || '';
        } else {
          // use provided external link directly
          imageUrl = urlInput.value.trim();
          // basic validation
          try{ new URL(imageUrl); }catch(e){ alert('‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
        }

        // insert record with created_by so RLS can validate
        const { data: insData, error: insErr } = await supabaseClient.from('artworks').insert({ title, description: desc, image_url: imageUrl, published: publish, created_by: userId }).select();
        if(insErr){
          const msg = formatErr(insErr);
          console.error('Insert error object:', insErr);
          alert('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + msg);
          if(msg.toLowerCase().includes('row-level') || msg.toLowerCase().includes('row level')){
            rlsHelp.classList.remove('hidden');
          }
          logLast('Insert failed: ' + msg);
          return;
        }

        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        artForm.reset();
        // reset UI: show file input by default
        document.getElementById('art-source-file').checked = true;
        document.getElementById('art-url').classList.add('hidden');
        document.getElementById('art-file').classList.remove('hidden');

        await loadAdminList();
        loadGallery();

      }catch(err){
        console.error('Unexpected error during upload:', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å: ' + formatErr(err));
        rlsHelp.classList.remove('hidden');
        logLast('Unexpected upload error: ' + formatErr(err));
      }
    });

    async function loadAdminList(){
      adminList.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
      try{
        const { data, error } = await supabaseClient.from('artworks').select('*').order('created_at', {ascending:false});
        if(error){ const msg = formatErr(error); adminList.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + msg; console.error(error); return; }
        adminList.innerHTML = '';
        if(!data || data.length===0){ adminList.innerHTML = '<div class="opacity-80">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô</div>'; return; }
        for(const art of data){
          const node = document.createElement('div');
          node.className = 'p-3 glass rounded';
          node.innerHTML = `
            <div class="flex gap-3">
              <img src="${art.image_url||'https://via.placeholder.com/120'}" class="w-28 h-20 object-cover rounded" />
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div>
                    <div class="font-semibold">${escapeHtml(art.title)}</div>
                    <div class="text-sm opacity-80">${escapeHtml(art.description || '')}</div>
                  </div>
                  <div class="text-sm opacity-80">${new Date(art.created_at).toLocaleString()}</div>
                </div>
                <div class="mt-2 flex gap-2 items-center">
                  <span class="px-2 py-1 text-xs rounded bg-white/10">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${art.published ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà' : '‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà'}</span>
                  <button data-id="${art.id}" class="btn-toggle px-3 py-1 rounded bg-yellow-500">‡∏™‡∏•‡∏±‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</button>
                  <button data-id="${art.id}" class="btn-delete px-3 py-1 rounded bg-red-600">Delete</button>
                </div>
              </div>
            </div>
          `;
          adminList.appendChild(node);
        }
        // wire up buttons
        document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          if(!confirm('‡∏à‡∏∞‡∏•‡∏ö‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
          try{
            const { error } = await supabaseClient.from('artworks').delete().eq('id', id);
            if(error){ const msg = formatErr(error); alert('‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + msg); console.error(error); return; }
            await loadAdminList(); loadGallery();
          }catch(err){ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏•‡∏ö: ' + formatErr(err)); }
        }));
        document.querySelectorAll('.btn-toggle').forEach(b => b.addEventListener('click', async (e)=>{
          const id = e.currentTarget.dataset.id;
          try{
            const { data } = await supabaseClient.from('artworks').select('published').eq('id', id).single();
            const next = !data.published;
            const { error } = await supabaseClient.from('artworks').update({ published: next }).eq('id', id);
            if(error){ const msg = formatErr(error); alert('‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ' + msg); console.error(error); return; }
            loadAdminList(); loadGallery();
          }catch(err){ console.error(err); alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï: ' + formatErr(err)); }
        }));
      }catch(err){ console.error(err); adminList.innerHTML = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + formatErr(err); }
    }

    // util
    function escapeHtml(s){ if(!s) return ''; return s.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  </script>
</body>
</html>
